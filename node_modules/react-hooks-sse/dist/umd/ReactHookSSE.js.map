{"version":3,"file":"ReactHookSSE.js","sources":["../../src/createSourceManager.ts","../../src/SSEContext.ts","../../src/useSSE.ts"],"sourcesContent":["import { Source, Listener } from './source';\n\ntype State = {\n  source: Source | null;\n  listenersByName: Map<string, Set<Listener>>;\n};\n\nexport type SourceManager = {\n  addEventListener(name: string, listener: Listener): void;\n  removeEventListener(name: string, listener: Listener): void;\n};\n\nexport const createSourceManager = (\n  createSource: () => Source\n): SourceManager => {\n  const state: State = {\n    source: null,\n    listenersByName: new Map(),\n  };\n\n  return {\n    addEventListener(name, listener) {\n      if (!state.listenersByName.size) {\n        state.source = createSource();\n      }\n\n      if (!state.source) {\n        throw new Error(\"The source doesn't exist\");\n      }\n\n      const listeners = state.listenersByName.get(name) || new Set();\n\n      listeners.add(listener);\n\n      state.listenersByName.set(name, listeners);\n\n      state.source.addEventListener(name, listener);\n    },\n    removeEventListener(name, listener) {\n      if (!state.source) {\n        throw new Error(\"The source doesn't exist\");\n      }\n\n      const listeners = state.listenersByName.get(name) || new Set();\n\n      listeners.delete(listener);\n\n      if (!listeners.size) {\n        state.listenersByName.delete(name);\n      }\n\n      state.source.removeEventListener(name, listener);\n\n      if (!state.listenersByName.size) {\n        state.source.close();\n        state.source = null;\n      }\n    },\n  };\n};\n","import * as React from 'react';\nimport { SourceManager, createSourceManager } from './createSourceManager';\nimport { Source } from './source';\n\nexport const SSEContext = React.createContext<SourceManager | null>(null);\n\nexport const SSEConsumer = SSEContext.Consumer;\n\ntype WithSource = { source: () => Source };\ntype WithEndpoint = { endpoint: string };\ntype Props = React.PropsWithChildren<WithSource | WithEndpoint>;\n\nconst isPropsWithSource = (_: WithSource | WithEndpoint): _ is WithSource =>\n  'source' in _;\n\nconst createDefaultSource = (endpoint: string) => (): Source =>\n  new window.EventSource(endpoint);\n\nexport const SSEProvider: React.FC<Props> = ({ children, ...props }) => {\n  const [source] = React.useState(() =>\n    createSourceManager(\n      !isPropsWithSource(props)\n        ? createDefaultSource(props.endpoint)\n        : props.source\n    )\n  );\n\n  return React.createElement(\n    SSEContext.Provider,\n    {\n      value: source,\n    },\n    children\n  );\n};\n","import { useContext, useReducer, useEffect } from 'react';\nimport { Listener, Event } from './source';\nimport { SSEContext } from './SSEContext';\n\ntype Action<T> = { event: Event; data: T };\ntype StateReducer<S, T> = (state: S, changes: Action<T>) => S;\ntype Parser<T> = (data: any) => T;\n\nexport type Options<S, T = S> = {\n  stateReducer?: StateReducer<S, T>;\n  parser?: Parser<T>;\n  context?: typeof SSEContext;\n};\n\nexport function useSSE<S, T = S>(\n  eventName: string,\n  initialState: S,\n  options?: Options<S, T>\n): S {\n  const {\n    stateReducer = (_: S, action: Action<any>) => action.data,\n    parser = (data: any) => JSON.parse(data),\n    context = SSEContext,\n  } = options || {};\n\n  const source = useContext(context);\n  const [state, dispatch] = useReducer<StateReducer<S, T>>(\n    stateReducer,\n    initialState\n  );\n\n  if (!source) {\n    throw new Error(\n      'Could not find an SSE context; You have to wrap useSSE() in a <SSEProvider>.'\n    );\n  }\n\n  useEffect(() => {\n    const listener: Listener = event => {\n      const data = parser(event.data);\n\n      dispatch({\n        event,\n        data,\n      });\n    };\n\n    source.addEventListener(eventName, listener);\n\n    return () => {\n      source.removeEventListener(eventName, listener);\n    };\n  }, []);\n\n  return state;\n}\n"],"names":["createSourceManager","createSource","state","source","listenersByName","Map","addEventListener","name","listener","size","Error","listeners","get","Set","add","set","removeEventListener","delete","close","SSEContext","React","createContext","SSEConsumer","Consumer","isPropsWithSource","_","createDefaultSource","endpoint","window","EventSource","SSEProvider","children","props","useState","createElement","Provider","value","useSSE","eventName","initialState","options","stateReducer","action","data","parser","JSON","parse","context","useContext","useReducer","dispatch","useEffect","event"],"mappings":"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"}